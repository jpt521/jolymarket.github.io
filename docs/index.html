<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Polymarket — Live Big Trades — Rams vs. Falcons</title>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #f7f7f9;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --green: #10b981;
      --red: #ef4444;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 6px;
    }
    .sub {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 14px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }
    .pill {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: var(--panel);
      font-size: 12px;
      color: var(--muted);
    }
    .pill strong { color: var(--text); font-weight: 700; }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    thead th {
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      background: var(--panel);
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    tbody tr:hover { background: #fafafa; }
    .buy { color: var(--green); font-weight: 700; }
    .sell { color: var(--red); font-weight: 700; }
    .muted { color: var(--muted); }

    /* ---- Flow meter (last 60m) ---- */
    .flowcard {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
      padding: 12px 12px;
      margin: 10px 0 12px;
    }
    .flowtitle {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .flowrow {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    .flowlabel {
      width: 120px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .flowbarwrap {
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .flowbar {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: #111827;
      transition: width 180ms ease;
    }
    .flowval {
      width: 230px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      color: var(--text);
    }
    .flowsub {
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Live Big Trades — Rams vs. Falcons</h1>
    <div class="sub">Auto-refreshes. Showing trades with size ≥ 1,000. Times shown in Eastern.</div>

    <div class="row">
      <div class="pill">Market: <strong>0x7261b06fc5515452b81b4831e158fd45730cfb56b650518af48a0393a99bbfae</strong></div>
      <div class="pill">A: <strong>Rams</strong></div>
      <div class="pill">B: <strong>Falcons</strong></div>
      <div class="pill">Refresh: <strong id="refreshEvery">—</strong>s</div>
      <div class="pill">Last update: <strong id="lastUpdate">—</strong></div>
    </div>

    <!-- Flow meter (last 60m, big trades only) -->
    <div class="flowcard">
      <div class="flowtitle">
        <strong>Accumulation (last 60m)</strong>
        <span class="muted">big trades only (size ≥ <span id="minSizeLabel">—</span>)</span>
      </div>

      <div class="flowrow">
        <div class="flowlabel" id="teamALabel">—</div>
        <div class="flowbarwrap">
          <div class="flowbar" id="teamABar"></div>
        </div>
        <div class="flowval" id="teamAVal">—</div>
      </div>

      <div class="flowrow">
        <div class="flowlabel" id="teamBLabel">—</div>
        <div class="flowbarwrap">
          <div class="flowbar" id="teamBBar"></div>
        </div>
        <div class="flowval" id="teamBVal">—</div>
      </div>

      <div class="flowsub muted" id="flowSub">—</div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 160px;">time (ET)</th>
          <th style="width: 70px;">side</th>
          <th style="width: 140px;">book</th>
          <th style="width: 90px;">price</th>
          <th style="width: 120px;">size</th>
          <th style="width: 140px;">notional</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td class="muted" colspan="6">Loading…</td></tr>
      </tbody>
    </table>

    <div class="sub" style="margin-top: 12px;">
      Note: this fetches the latest 1000 trades each tick, filters by size, then sorts by newest.
    </div>
  </div>

  <script>
    const DATA_BASE = "https://data-api.polymarket.com";
    const MARKET = "0x7261b06fc5515452b81b4831e158fd45730cfb56b650518af48a0393a99bbfae";
    const REFRESH_SECONDS = 10;
    const MIN_SIZE = 1000;
    const TOP_N = 25;

    function fmt2(x) {
      const n = Number(x);
      if (!isFinite(n)) return String(x);
      return n.toLocaleString(undefined, {maximumFractionDigits: 2});
    }

    function fmt4(x) {
      const n = Number(x);
      if (!isFinite(n)) return String(x);
      return n.toFixed(4);
    }

    function fmtMoney(x) {
      const n = Number(x);
      if (!isFinite(n)) return String(x);
      const sign = n < 0 ? "-" : "";
      const abs = Math.abs(n);
      if (abs >= 1e6) return `${sign}$${(abs/1e6).toFixed(2)}M`;
      if (abs >= 1e3) return `${sign}$${(abs/1e3).toFixed(2)}K`;
      return `${sign}$${abs.toFixed(2)}`;
    }

    function clamp(x, lo, hi) {
      return Math.max(lo, Math.min(hi, x));
    }

    function toET(isoOrEpoch) {
      let d;
      if (typeof isoOrEpoch === "number") d = new Date(isoOrEpoch * 1000);
      else d = new Date(String(isoOrEpoch));
      return new Intl.DateTimeFormat(undefined, {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false,
        timeZone: 'America/New_York'
      }).format(d);
    }

    function outcomeNorm(o) {
      if (o === null || o === undefined) return null;
      const s = String(o).trim().toLowerCase();
      if (s === "yes") return "YES";
      if (s === "no") return "NO";
      if (s === "Rams".trim().toLowerCase()) return "YES";
      if (s === "Falcons".trim().toLowerCase()) return "NO";
      return null;
    }

    function bookLabel(oc) {
      if (oc === "YES") return "Rams YES";
      if (oc === "NO") return "Falcons YES";
      return "UNKNOWN";
    }

    async function fetchTrades() {
      const url = `${DATA_BASE}/trades?limit=1000&market=${encodeURIComponent(MARKET)}`;
      const res = await fetch(url, {cache: "no-store"});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    function computeLastHourFlow(trades) {
      const nowMs = Date.now();
      const cutoffMs = nowMs - 60 * 60 * 1000;

      let aShares = 0, bShares = 0;
      let aNotional = 0, bNotional = 0;
      let count = 0;

      for (const t of trades) {
        const tsRaw = t.timestamp ?? t.createdAt ?? t.time;
        const timeMs = (typeof tsRaw === "number") ? (tsRaw * 1000) : Date.parse(String(tsRaw));
        if (!isFinite(timeMs) || timeMs < cutoffMs) continue;

        const price = Number(t.price ?? 0);
        const size = Number(t.size ?? 0);
        const side = String(t.side ?? "?").toUpperCase();
        const oc = outcomeNorm(t.outcome);

        if (!oc) continue;
        if (size < MIN_SIZE) continue;

        const sign = (side === "BUY") ? 1 : (side === "SELL") ? -1 : 0;
        if (sign === 0) continue;

        const notional = price * size;
        count += 1;

        // A is YES token (mi.yes_label). B is NO token displayed as "mi.no_label YES".
        if (oc === "YES") {
          aShares += sign * size;
          aNotional += sign * notional;
        } else if (oc === "NO") {
          bShares += sign * size;
          bNotional += sign * notional;
        }
      }

      return {
        aShares, bShares, aNotional, bNotional,
        count,
        cutoffEt: toET(cutoffMs / 1000)
      };
    }

    function renderFlowMeter(flow) {
      const A = "Rams";
      const B = "Falcons";

      document.getElementById("teamALabel").textContent = A;
      document.getElementById("teamBLabel").textContent = B;
      document.getElementById("minSizeLabel").textContent = fmt2(MIN_SIZE);

      // normalize by abs(net notional) so the “bigger” accumulator shows wider
      const maxAbs = Math.max(Math.abs(flow.aNotional), Math.abs(flow.bNotional), 1);
      const aPct = clamp((Math.abs(flow.aNotional) / maxAbs) * 100, 0, 100);
      const bPct = clamp((Math.abs(flow.bNotional) / maxAbs) * 100, 0, 100);

      const aBar = document.getElementById("teamABar");
      const bBar = document.getElementById("teamBBar");

      aBar.style.width = `${aPct.toFixed(1)}%`;
      bBar.style.width = `${bPct.toFixed(1)}%`;

      aBar.style.background = (flow.aNotional >= 0) ? "var(--green)" : "var(--red)";
      bBar.style.background = (flow.bNotional >= 0) ? "var(--green)" : "var(--red)";

      document.getElementById("teamAVal").textContent =
        `net shares: ${fmt2(flow.aShares)} | net $: ${fmtMoney(flow.aNotional)}`;

      document.getElementById("teamBVal").textContent =
        `net shares: ${fmt2(flow.bShares)} | net $: ${fmtMoney(flow.bNotional)}`;

      let winner = "Tie";
      if (flow.aNotional !== flow.bNotional) {
        winner = (flow.aNotional > flow.bNotional) ? A : B;
      }

      document.getElementById("flowSub").textContent =
        `Window: ${flow.cutoffEt} → now. Big-trade prints counted: ${flow.count}. Accumulating more (by net $): ${winner}.`;
    }

    function renderTop(trades) {
      const rows = document.getElementById("rows");
      const mapped = [];

      for (const t of trades) {
        const tsRaw = t.timestamp ?? t.createdAt ?? t.time;
        const price = Number(t.price ?? 0);
        const size = Number(t.size ?? 0);
        const side = String(t.side ?? "?").toUpperCase();
        const oc = outcomeNorm(t.outcome);

        if (!oc) continue;
        if (size < MIN_SIZE) continue;

        const notional = price * size;
        const timeMs = (typeof tsRaw === "number") ? (tsRaw * 1000) : Date.parse(String(tsRaw));

        mapped.push({
          timeEt: toET(tsRaw),
          timeMs: timeMs,
          side,
          book: bookLabel(oc),
          price,
          size,
          notional
        });
      }

      mapped.sort((a,b) => (b.timeMs ?? 0) - (a.timeMs ?? 0));
      const top = mapped.slice(0, TOP_N);

      if (top.length === 0) {
        rows.innerHTML = `<tr><td class="muted" colspan="6">No mappable trades in latest pull (size ≥ ${MIN_SIZE}).</td></tr>`;
        return;
      }

      rows.innerHTML = top.map(r => {
        const cls = (r.side === "BUY") ? "buy" : (r.side === "SELL") ? "sell" : "";
        return `
          <tr>
            <td>${r.timeEt}</td>
            <td class="${cls}">${r.side}</td>
            <td>${r.book}</td>
            <td>${fmt4(r.price)}</td>
            <td>${fmt2(r.size)}</td>
            <td>${fmt2(r.notional)}</td>
          </tr>`;
      }).join("");
    }

    async function tick() {
      try {
        const trades = await fetchTrades();

        // NEW: flow meter (last 60m, big trades only)
        const flow = computeLastHourFlow(trades);
        renderFlowMeter(flow);

        renderTop(trades);
        document.getElementById("lastUpdate").textContent = toET(Date.now()/1000);
      } catch (e) {
        console.error(e);
        const rows = document.getElementById("rows");
        rows.innerHTML = `<tr><td class="muted" colspan="6">Error fetching trades: ${String(e)}</td></tr>`;
      }
    }

    document.getElementById("refreshEvery").textContent = String(REFRESH_SECONDS);
    tick();
    setInterval(tick, REFRESH_SECONDS * 1000);
  </script>
</body>
</html>
